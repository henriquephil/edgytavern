{"version":3,"file":"index.modern.js","sources":["../src/auth/auth.js","../src/auth/Login.js"],"sourcesContent":["import axios from \"axios\"\r\nimport moment from \"moment\"\r\n\r\nconst SESSION_INFO = 'sessionInfo'\r\n\r\nclass Auth {\r\n  refreshing = false\r\n\r\n  async authenticate(username, password) {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (sessionInfo) throw 'already authenticated'\r\n    await this._authenticate(username, password)\r\n  }\r\n\r\n  async authenticateGoogle(googleResponse) {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (sessionInfo) throw 'already authenticated'\r\n    await this._authenticateGoogle(googleResponse.accessToken)\r\n    return googleResponse\r\n  }\r\n\r\n  async refreshAndGetSession() {\r\n    while(this.refreshing) {\r\n      await new Promise(res => setTimeout(res, 1000));\r\n    }\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (!sessionInfo) throw 'not authenticated'\r\n    if (moment().isBefore(sessionInfo.expiresAt)) {\r\n      return sessionInfo\r\n    }\r\n    return await this._refreshToken(sessionInfo)\r\n  }\r\n\r\n  async signOut() {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (!sessionInfo) throw 'not authenticated'\r\n    axios.post(`/api/security/auth/logout`, null, { headers: { 'Authorization': sessionInfo.mountedToken } })\r\n    localStorage.removeItem(SESSION_INFO)\r\n    window.location = window.location // not sure\r\n  }\r\n\r\n  // privates\r\n  async _authenticate(username, password) {\r\n    const authRequest = new URLSearchParams()\r\n    authRequest.append('client_id', 'client')\r\n    authRequest.append('client_secret', 'secret')\r\n    authRequest.append('grant_type', 'password')\r\n    authRequest.append('username', username)\r\n    authRequest.append('password', password)\r\n    const tokenInfo = (await axios.post(`/api/security/auth/token`, authRequest)).data\r\n    await this._persistTokenInfo(tokenInfo)\r\n  }\r\n\r\n  async _authenticateGoogle(accessToken) {\r\n    const tokenInfo = (await axios.post(\"/api/security/auth/google\", { clientId: 'client', accessToken })).data\r\n    await this._persistTokenInfo(tokenInfo)\r\n  }\r\n\r\n  async _refreshToken(sessionInfo) {\r\n    this.refreshing = true\r\n    const refreshRequest = new URLSearchParams()\r\n    refreshRequest.append('client_id', 'client')\r\n    refreshRequest.append('client_secret', 'secret')\r\n    refreshRequest.append('grant_type', 'refresh_token')\r\n    refreshRequest.append('refresh_token', sessionInfo.tokenInfo.refresh_token)\r\n    const tokenInfo = (await axios.post(`/api/security/auth/token`, refreshRequest)).data\r\n    const newTokenInfo = await this._persistTokenInfo(tokenInfo)\r\n    this.refreshing = false\r\n    return newTokenInfo\r\n  }\r\n\r\n  async _persistTokenInfo(tokenInfo) {\r\n    const authAccessToken = `${tokenInfo.token_type} ${tokenInfo.access_token}`\r\n    const sessionInfo = this._getStorageSessionInfo() || \r\n                        { userInfo: (await axios.get(`/api/security/auth/userInfo`, { headers: { 'Authorization': authAccessToken } })).data }\r\n    sessionInfo.tokenInfo = tokenInfo\r\n    sessionInfo.mountedToken = authAccessToken\r\n    sessionInfo.expiresAt = moment().add(tokenInfo.expires_in, 's')\r\n    localStorage.setItem(SESSION_INFO, JSON.stringify(sessionInfo))\r\n    return sessionInfo\r\n  }\r\n\r\n  _getStorageSessionInfo() {\r\n    const storageSessionInfo = localStorage.getItem(SESSION_INFO)\r\n    return JSON.parse(storageSessionInfo)\r\n  }\r\n}\r\n\r\nexport default new Auth()","import React, { useState } from \"react\"\r\nimport style from './login.module.css'\r\nimport formStyle from '../form.module.css'\r\nimport auth from \"./auth\"\r\nimport GoogleLogin from 'react-google-login'\r\n\r\nfunction Login() {\r\n  const [ username, setUsername ] = useState(null)\r\n  const [ password, setPassword ] = useState(null)\r\n\r\n  function login() {\r\n    auth.authenticate(username, password)\r\n      .then(res => window.location = window.location)\r\n  }\r\n  function googleLogin(googleResponse) {\r\n    auth.authenticateGoogle(googleResponse)\r\n      .then(res => window.location = window.location)\r\n  }\r\n\r\n  return (\r\n    <div className={style.loginPage}>\r\n      <div className={style.loginForm}>\r\n        <div className={formStyle.field}>\r\n            <label>e-mail</label>\r\n            <input type=\"email\" value={username} onChange={e => setUsername(e.target.value)}/>\r\n        </div>\r\n        <div className={formStyle.field}>\r\n            <label>Password</label>\r\n            <input type=\"password\" value={password} onChange={e => setPassword(e.target.value)}/>\r\n        </div>\r\n        <div className={formStyle.field}>\r\n          <button disabled={!username || !password} onClick={() => login()}>Login</button>\r\n        </div>\r\n        <GoogleLogin\r\n          clientId=\"595477155318-e8j9fmbikkb6ihdt2iomjhtptpuq3giu.apps.googleusercontent.com\"\r\n          buttonText=\"Login\"\r\n          onSuccess={googleLogin}\r\n          onFailure={res => console.log(res)} // TODO improve\r\n          cookiePolicy={'single_host_origin'}\r\n          buttonText=\"Login with Google\"\r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Login"],"names":["SESSION_INFO","Auth","refreshing","authenticate","username","password","sessionInfo","_getStorageSessionInfo","_authenticate","authenticateGoogle","googleResponse","_authenticateGoogle","accessToken","refreshAndGetSession","Promise","res","setTimeout","moment","isBefore","expiresAt","_refreshToken","signOut","axios","post","headers","mountedToken","localStorage","removeItem","window","location","authRequest","URLSearchParams","append","tokenInfo","data","_persistTokenInfo","clientId","refreshRequest","refresh_token","newTokenInfo","authAccessToken","token_type","access_token","userInfo","get","add","expires_in","setItem","JSON","stringify","storageSessionInfo","getItem","parse","Login","setUsername","useState","setPassword","login","auth","then","googleLogin","style","loginPage","loginForm","formStyle","field","e","target","value","console","log"],"mappings":"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"}