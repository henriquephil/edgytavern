{"version":3,"file":"index.js","sources":["../src/auth/auth.js","../src/auth/Login.js"],"sourcesContent":["import axios from \"axios\"\r\nimport moment from \"moment\"\r\n\r\nconst SESSION_INFO = 'sessionInfo'\r\n\r\nclass Auth {\r\n  async authenticate(username, password) {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (sessionInfo) throw 'already authenticated'\r\n    await this._authenticate(username, password)\r\n  }\r\n\r\n  async authenticateGoogle(googleResponse) {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (sessionInfo) throw 'already authenticated'\r\n    await this._authenticateGoogle(googleResponse.accessToken)\r\n    return googleResponse\r\n  }\r\n\r\n  async refreshAndGetSession() {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (!sessionInfo) throw 'not authenticated'\r\n    if (moment().isBefore(sessionInfo.expiresAt)) {\r\n      return sessionInfo\r\n    }\r\n    return await this._refreshToken(sessionInfo)\r\n  }\r\n\r\n  async signOut() {\r\n    const sessionInfo = this._getStorageSessionInfo()\r\n    if (!sessionInfo) throw 'not authenticated'\r\n    axios.post(`/api/security/auth/logout`, null, { headers: { 'Authorization': sessionInfo.mountedToken } })\r\n    localStorage.removeItem(SESSION_INFO)\r\n    window.location = '/' // not sure\r\n  }\r\n\r\n  // privates\r\n  async _authenticate(username, password) {\r\n    const authRequest = new URLSearchParams()\r\n    authRequest.append('client_id', 'client')\r\n    authRequest.append('client_secret', 'secret')\r\n    authRequest.append('grant_type', 'password')\r\n    authRequest.append('username', username)\r\n    authRequest.append('password', password)\r\n    const tokenInfo = (await axios.post(`/api/security/auth/token`, authRequest)).data\r\n    await this._persistTokenInfo(tokenInfo)\r\n  }\r\n\r\n  async _authenticateGoogle(accessToken) {\r\n    const tokenInfo = (await axios.post(\"/api/security/auth/google\", { clientId: 'client', accessToken })).data\r\n    await this._persistTokenInfo(tokenInfo)\r\n  }\r\n\r\n  async _refreshToken(sessionInfo) {\r\n    const refreshRequest = new URLSearchParams()\r\n    refreshRequest.append('client_id', 'client')\r\n    refreshRequest.append('client_secret', 'secret')\r\n    refreshRequest.append('grant_type', 'refresh_token')\r\n    refreshRequest.append('refresh_token', sessionInfo.tokenInfo.refresh_token)\r\n    const tokenInfo = (await axios.post(`/api/security/auth/token`, refreshRequest)).data\r\n    return await this._persistTokenInfo(tokenInfo)\r\n  }\r\n\r\n  async _persistTokenInfo(tokenInfo) {\r\n    const authAccessToken = `${tokenInfo.token_type} ${tokenInfo.access_token}`\r\n    const sessionInfo = this._getStorageSessionInfo() || \r\n                        { userInfo: (await axios.get(`/api/security/auth/userInfo`, { headers: { 'Authorization': authAccessToken } })).data }\r\n    sessionInfo.tokenInfo = tokenInfo\r\n    sessionInfo.mountedToken = authAccessToken\r\n    sessionInfo.expiresAt = moment().add(tokenInfo.expires_in, 's')\r\n    localStorage.setItem(SESSION_INFO, JSON.stringify(sessionInfo))\r\n    return sessionInfo\r\n  }\r\n\r\n  _getStorageSessionInfo() {\r\n    const storageSessionInfo = localStorage.getItem(SESSION_INFO)\r\n    return JSON.parse(storageSessionInfo)\r\n  }\r\n}\r\n\r\nexport default new Auth()","import \"./login.css\"\r\nimport auth from \"./auth\"\r\nimport React, { useState } from \"react\"\r\nimport GoogleLogin from 'react-google-login'\r\n\r\nfunction Login() {\r\n  const [ username, setUsername ] = useState(null)\r\n  const [ password, setPassword ] = useState(null)\r\n\r\n  function login() {\r\n    auth.authenticate(username, password)\r\n      .then(res => window.location = window.location)\r\n  }\r\n  function googleLogin(googleResponse) {\r\n    auth.authenticateGoogle(googleResponse)\r\n      .then(res => window.location = window.location)\r\n  }\r\n\r\n  return (\r\n    <div className=\"login-page\">\r\n      <div className=\"login-form\">\r\n        <div className=\"form-input\">\r\n            <label>e-mail</label>\r\n            <input type=\"email\" value={username} onChange={e => setUsername(e.target.value)}/>\r\n        </div>\r\n        <div className=\"form-input\">\r\n            <label>Password</label>\r\n            <input type=\"password\" value={password} onChange={e => setPassword(e.target.value)}/>\r\n        </div>\r\n        <div className=\"form-input\">\r\n          <button disabled={!username || !password} onClick={() => login()}>Login</button>\r\n        </div>\r\n        <GoogleLogin\r\n          clientId=\"595477155318-e8j9fmbikkb6ihdt2iomjhtptpuq3giu.apps.googleusercontent.com\"\r\n          buttonText=\"Login\"\r\n          onSuccess={googleLogin}\r\n          onFailure={res => console.log(res)} // TODO improve\r\n          cookiePolicy={'single_host_origin'}\r\n          buttonText=\"Login with Google\"\r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Login"],"names":["SESSION_INFO","Auth","authenticate","username","password","sessionInfo","_getStorageSessionInfo","_authenticate","authenticateGoogle","googleResponse","_authenticateGoogle","accessToken","refreshAndGetSession","moment","isBefore","expiresAt","_refreshToken","signOut","axios","post","headers","mountedToken","localStorage","removeItem","window","location","authRequest","URLSearchParams","append","tokenInfo","data","_persistTokenInfo","clientId","refreshRequest","refresh_token","userInfo","authAccessToken","add","expires_in","setItem","JSON","stringify","token_type","access_token","get","storageSessionInfo","getItem","parse","Login","useState","setUsername","setPassword","login","auth","then","res","googleLogin","React","e","target","value","console","log"],"mappings":"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"}